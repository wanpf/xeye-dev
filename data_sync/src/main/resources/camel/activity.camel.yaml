- route:
    id: route-6cce
    description: Find existing actvity logs record index
    nodePrefixId: route-984
    from:
      id: from-08ee
      description: Activity Log Capture Start
      uri: direct
      parameters:
        name: activity_id
      steps:
        - setProperty:
            id: setProperty-6287
            name: machine
            expression:
              simple:
                id: simple-e98f
                expression: ${body}
        - to:
            id: to-7f50
            uri: sql
            parameters:
              query: >-
                select COALESCE(MAX(cid), 0) as cid from activity_logs where
                machine = :#${exchangeProperty.machine}
        - setProperty:
            id: setProperty-5b68
            name: aid
            expression:
              simple:
                id: simple-6bcc
                expression: ${body.get(0).get("cid")}
        - to:
            id: to-0e46
            uri: direct
            parameters:
              name: activity_totals
- route:
    id: route-cde9
    description: Get Activity Logs Delta Count
    nodePrefixId: route-2b5
    from:
      id: from-0abe
      description: start
      uri: direct
      parameters:
        name: activity_totals
      steps:
        - log:
            id: log-1fc4
            message: >-
              Fetching count of new activity log records of host machine
              ${exchangeProperty.machine}  with index > ${exchangeProperty.aid}
        - setHeader:
            id: setHeader-7f02
            name: Exchange.HTTP_URI
            expression:
              simple:
                id: simple-f185
                expression: http://{{gateway.address}}/${exchangeProperty.machine}/api
        - setBody:
            id: setBody-bbcc
            expression:
              simple:
                id: simple-1f65
                expression: >-
                  select count(*) as total from log where id >
                  ${exchangeProperty.aid}
        - to:
            id: to-12fe
            description: Retrieve client activity ${body} logs
            uri: http
            parameters:
              httpMethod: POST
              httpUri: '{{gateway.address}}/'
              authMethodPriority: Basic
              authPassword: '{{gateway.auth.password}}'
              authUsername: '{{gateway.auth.user}}'
        - unmarshal:
            id: unmarshal-f1be
            json:
              id: json-1b55
              library: Jackson
              useList: true
              enableFeatures: ACCEPT_SINGLE_VALUE_AS_ARRAY
        - setHeader:
            id: setHeader-e7d6
            name: total
            expression:
              simple:
                id: simple-89ff
                expression: ${body.get(0).get("total")}
        - log:
            id: log-6862
            message: Delta of ${header.total} activity log entries
        - to:
            id: to-6c99
            uri: direct
            parameters:
              name: activity_loop
- route:
    id: route-ab08
    description: Loop to retrieve delta items for activity logs per batch size
    nodePrefixId: route-2f3
    from:
      id: from-20be
      uri: direct
      parameters:
        name: activity_loop
      steps:
        - process:
            id: process-bbaf
            ref: LoopCounter
        - loop:
            id: loop-d197
            expression:
              header:
                id: header-75ae
                expression: loops
            steps:
              - to:
                  id: to-d3a7
                  uri: direct
                  parameters:
                    name: activity_logs
- route:
    id: route-ba5e
    description: Retrieve Activity Logs
    nodePrefixId: route-01e
    from:
      id: from-fc1e
      description: start
      uri: direct
      parameters:
        name: activity_logs
      steps:
        - log:
            id: log-1fc6
            message: >-
              Fetching activity log records of host machine
              ${exchangeProperty.machine}
        - setHeader:
            id: setHeader-7f04
            name: Exchange.HTTP_URI
            expression:
              simple:
                id: simple-f188
                expression: http://{{gateway.address}}/${exchangeProperty.machine}/api
        - setBody:
            id: setBody-bbcc
            expression:
              simple:
                id: simple-1f66
                expression: >-
                  select * from log where id > ${exchangeProperty.aid} order by
                  id limit {{batch.size}} offset
                  (${exchangeProperty.CamelLoopIndex} * {{batch.size}})
        - to:
            id: to-12ff
            description: Retrieve client ${body} activity logs
            uri: http
            parameters:
              httpMethod: POST
              httpUri: '{{gateway.address}}/'
              authMethodPriority: Basic
              authPassword: '{{gateway.auth.password}}'
              authUsername: '{{gateway.auth.user}}'
        - unmarshal:
            id: unmarshal-f1bf
            json:
              id: json-1b55
              library: Jackson
              useList: true
              enableFeatures: ACCEPT_SINGLE_VALUE_AS_ARRAY
        - to:
            id: to-d145
            uri: direct
            parameters:
              name: activity_handle
